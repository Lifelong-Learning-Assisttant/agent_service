#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è LaTeX —Ñ–æ—Ä–º—É–ª
"""
import asyncio
import json
from agent_system import AgentSystem
from langchain_tools import rag_generate_async
from unittest.mock import AsyncMock, patch

# –§–µ–π–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç –æ—Ç RAG —Å LaTeX —Ñ–æ—Ä–º—É–ª–∞–º–∏ –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
FAKE_RAG_RESPONSE = json.dumps({
    "answer": """
## –ú–µ—Ç–æ–¥ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Å–ø—É—Å–∫–∞

–ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Å–ø—É—Å–∫ - —ç—Ç–æ –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å.

–§–æ—Ä–º—É–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Å–æ–≤:
\\[ w_{t+1} = w_t - \\eta \\nabla L(w_t) \\]

–≥–¥–µ:
- \\( w_t \\) - –≤–µ—Å–∞ –Ω–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ t
- \\( \\eta \\) - learning rate
- \\( \\nabla L(w_t) \\) - –≥—Ä–∞–¥–∏–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Ç–µ—Ä—å

–î–ª—è MSE —Ñ—É–Ω–∫—Ü–∏—è –ø–æ—Ç–µ—Ä—å –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
\\[ MSE = \\frac{1}{n} \\sum_{i=1}^{n} (y_i - \\hat{y}_i)^2 \\]

–ò inline —Ñ–æ—Ä–º—É–ª–∞: \\( loss = (y - \\hat{y})^2 \\)
"""
})

async def test_reformatting():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç RAG"""
    
    print("üß™ –¢–µ—Å—Ç –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è LaTeX —Ñ–æ—Ä–º—É–ª")
    print("=" * 50)
    
    # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É
    agent = AgentSystem(provider="openrouter")
    
    # –ú–æ–∫–∞–µ–º rag_generate_async —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å —Ñ–µ–π–∫–æ–≤—ã–π –æ—Ç–≤–µ—Ç
    with patch('agent_system.rag_generate_async', new_callable=AsyncMock) as mock_rag:
        mock_rag.return_value = FAKE_RAG_RESPONSE
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º rag_answer_node –Ω–∞–ø—Ä—è–º—É—é
        from agent_session import AgentSession
        
        # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—É—é —Å–µ—Å—Å–∏—é
        session = AgentSession("test_session", agent)
        
        # –°–æ–∑–¥–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        state = {
            "question": "–û–±—ä—è—Å–Ω–∏ –º–µ—Ç–æ–¥ –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ —Å–ø—É—Å–∫–∞",
            "intent": "rag_answer"
        }
        
        print("\n1. –ò—Å—Ö–æ–¥–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç RAG (—Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏):")
        print("-" * 40)
        raw_data = json.loads(FAKE_RAG_RESPONSE)
        print(raw_data["answer"])
        
        # –í—ã–∑—ã–≤–∞–µ–º rag_answer_node
        print("\n2. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ...")
        result_state = await agent.rag_answer_node(state, session)
        
        print("\n3. –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:")
        print("-" * 40)
        print(result_state["final_answer"])
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
        final_answer = result_state["final_answer"]
        
        print("\n4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:")
        print("-" * 40)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
        if "\\[" in final_answer or "\\]" in final_answer:
            print("‚ùå –ù–∞–π–¥–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–ª–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã \\[...\\]")
        else:
            print("‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–ª–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã \\[...\\] –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
            
        if "\\(" in final_answer or "\\)" in final_answer:
            print("‚ùå –ù–∞–π–¥–µ–Ω—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ inline —Ñ–æ—Ä–º—É–ª—ã \\(...\\)")
        else:
            print("‚úÖ –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ inline —Ñ–æ—Ä–º—É–ª—ã \\(...\\) –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
        if "$$" in final_answer:
            print("‚úÖ –ù–∞–π–¥–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–ª–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã $$...$$")
        else:
            print("‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –±–ª–æ—á–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã $$...$$ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            
        if "$" in final_answer.replace("$$", ""):
            print("‚úÖ –ù–∞–π–¥–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ inline —Ñ–æ—Ä–º—É–ª—ã $...$")
        else:
            print("‚ùå –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ inline —Ñ–æ—Ä–º—É–ª—ã $...$ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
        
        print("\n‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
        
        # –û—á–∏—Å—Ç–∫–∞
        await session.cleanup()

if __name__ == "__main__":
    asyncio.run(test_reformatting())